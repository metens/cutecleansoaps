<!doctype html>
<html>

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Orders Admin</title>
    <link rel="stylesheet" href="/styles.css" />
    <style>
        .admin-wrap {
            max-width: 900px;
            margin: 0 auto;
            padding: 24px 16px;
        }

        .row {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }

        .card {
            border: 1px solid #eee;
            border-radius: 12px;
            padding: 14px;
            margin: 12px 0;
        }

        .muted {
            opacity: .75
        }

        .btn {
            padding: 8px 10px;
            border-radius: 10px;
            border: 1px solid #ddd;
            background: #fff;
            cursor: pointer
        }

        .btn.primary {
            border-color: #000
        }

        input {
            padding: 8px 10px;
            border-radius: 10px;
            border: 1px solid #ddd
        }

        pre {
            white-space: pre-wrap
        }
    </style>
</head>

<body>
    <div class="admin-wrap">
        <h1>Orders</h1>

        <div class="row" style="margin:12px 0 18px;">
            <input id="token" placeholder="Admin token" style="min-width:260px;" />
            <button class="btn primary" id="load">Load orders</button>
            <span class="muted" id="status"></span>
        </div>

        <div id="orders"></div>
    </div>

    <script>
        const $ = (id) => document.getElementById(id);

        function renderOrder(o, token) {
            const items = (o.items || [])
                .map(it => `${it.soapId} × ${it.qty}`)
                .join(", ");

            const ship = o.shipping || {};
            const addr = [
                ship.name,
                ship.phone,
                ship.address1,
                ship.address2,
                [ship.city, ship.state, ship.zip].filter(Boolean).join(", "),
                ship.country
            ].filter(Boolean).join("\n");

            const created = o.createdAt ? new Date(o.createdAt).toLocaleString() : "(no time)";

            return `
        <div class="card">
          <div class="row" style="justify-content:space-between;">
            <div>
              <strong>${o.status || "?"}</strong>
              <span class="muted"> · ${created}</span>
              <div class="muted" style="font-size:12px;">${o.id}</div>
            </div>
          </div>

          <div style="margin-top:10px;">
            <div><strong>Email:</strong> ${o.customerEmail || "(none)"}</div>
            <div style="margin-top:6px;"><strong>Items:</strong> ${items || "(none)"}</div>
          </div>

          <div style="margin-top:10px;">
            <strong>Ship to:</strong>
            <pre style="margin:6px 0 0;">${addr || "(no address)"}</pre>
          </div>

          <div class="row" style="margin-top:12px;">
            <input placeholder="Tracking #" value="${o.trackingNumber || ""}" data-track-for="${o.id}" />
            <button class="btn" data-action="update" data-order="${o.id}" data-status="packing">Packing</button>
            <button class="btn" data-action="update" data-order="${o.id}" data-status="shipped">Shipped</button>
            <button class="btn" data-action="update" data-order="${o.id}" data-status="delivered">Delivered</button>
          </div>
          <div class="muted" id="msg-${o.id}" style="margin-top:8px;font-size:12px;"></div>
        </div>
      `;
        }

        async function loadOrders() {
            const token = $("token").value.trim();
            if (!token) return alert("Paste your admin token first.");

            $("status").textContent = "Loading…";
            const res = await fetch(`/api/admin-list-orders?token=${encodeURIComponent(token)}`);
            const data = await res.json().catch(() => ({}));

            if (!res.ok) {
                $("status").textContent = "";
                return alert(data.error || "Failed to load orders.");
            }

            const orders = data.orders || [];
            $("orders").innerHTML = orders.map(o => renderOrder(o, token)).join("");
            $("status").textContent = `Loaded ${orders.length} orders`;
        }

        document.addEventListener("click", async (e) => {
            const btn = e.target.closest('button[data-action="update"]');
            if (!btn) return;

            const token = $("token").value.trim();
            if (!token) return alert("Paste your admin token first.");

            const orderId = btn.dataset.order;
            const status = btn.dataset.status;

            const trackInput = document.querySelector(`input[data-track-for="${CSS.escape(orderId)}"]`);
            const trackingNumber = trackInput ? trackInput.value.trim() : "";

            await updateOrder(orderId, status, trackingNumber, token);
        });
        async function updateOrder(orderId, status, trackingNumber, token) {
            const msgEl = document.getElementById(`msg-${orderId}`);
            if (msgEl) msgEl.textContent = "Updating…";

            const res = await fetch(`/api/admin-update-order?token=${encodeURIComponent(token)}`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ orderId, status, trackingNumber }),
            });

            const data = await res.json().catch(() => ({}));

            if (!res.ok) {
                if (msgEl) msgEl.textContent = data.error || "Update failed.";
                return;
            }

            if (msgEl) msgEl.textContent = "Updated!";
            loadOrders();
        }

        window.updateOrder = updateOrder;
        $("load").addEventListener("click", loadOrders);
    </script>
</body>

</html>